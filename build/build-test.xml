<project name="RailoTest" default="test" basedir="." xmlns:antcontrib="antlib:net.sf.antcontrib">
    
	<description>Ant build file to test Railo builds</description>

	<!-- Load properties -->
	<property file="build.properties"/>
	
	<target name="build.and.test" depends="build,test">
	</target>

	<target name="test.noxml">
		<delete dir="${war.target.dir}" />
		<unzip dest="${war.target.dir}" src="${railobuild.dist.dir}/railo-${railo.build.version.long}.war" />
		<mapping physical="${src.dir}/../tests" virtual="/tests"/>
		<customtag physical="${src.dir}/../tests/jira" virtual="/tests/jira"/>
		<railo-datasource name="railo_mirror" jdbcstring="jdbc:h2:${temp.dir}/h2dbs/railo-db/railo-db"/>
		<server-run>
			<!-- <antcontrib:runtarget target="server.openUrl"/> -->
			<get src="${server.url}" dest="${tests.dir}/results/jira.html" verbose="true" ignoreerrors="false" retries="0" maxtime="777" />
		</server-run>
	</target>
	
	<target name="test">

		<property file="${src.dir}/railo-java/railo-core/src/railo/runtime/Info.ini" prefix="railoini"/>
		<antcontrib:var name="railo.version" value="${railoini.number}" />
		<antcontrib:var name="war.target.dir" value="${dist.dir}/railo.war" />
		<antcontrib:var name="runwar.war.path" value="${war.target.dir}" />
		<antcontrib:var name="server.sharedlibs" value="false" />
		<antcontrib:var name="server.jvm.args" value="-Xms256M -Xmx326M -XX:PermSize=128M -XX:MaxPermSize=128M  -Djava.net.preferIPv4Stack=true" />
		<antcontrib:var name="railo.config.file" value="${war.target.dir}/WEB-INF/railo/railo-web.xml.cfm" />
		<antcontrib:var name="railo.web.config.dir" value="${war.target.dir}/WEB-INF/railo" />
		<antcontrib:var name="railo.web.config.file" value="${war.target.dir}/WEB-INF/railo/railo-web.xml.cfm" />
		<antcontrib:var name="railo.server.config.dir" value="${war.target.dir}/WEB-INF/lib/railo-server" />
		<antcontrib:var name="railo.server.config.file" value="${railo.server.config.dir}/context/railo-server.xml" />
		<antcontrib:var name="cfadmin.password" value="server" />
		<antcontrib:var name="cfml.request.timeout" value="30" />
		<antcontrib:runtarget target="railo.war.config" />
		<echo message="${mappings.file}" />
		<echo file="${src.dir}/tests/HttpAntRunner.cfc"><![CDATA[<cfcomponent extends="mxunit.runner.HttpAntRunner"></cfcomponent>]]></echo>
		<dependency groupId="org.mxunit" artifactId="core" version="2.1.3" mapping="/mxunit" />
		<mapping physical="${src.dir}/tests" virtual="/railo-tests"/>
		<mapping physical="${src.dir}/tests/testcases" virtual="/testcases"/>
		<railo-datasource name="railo_mirror" jdbcstring="jdbc:h2:${temp.dir}/h2dbs/railo-db/railo-db"/>
		<server-run>
			<mxunit-call 
				path="${mxunit.tests.dir}" componentPath="${mxunit.componentpath}"
				packageName="testcases" recurse="${mxunit.recurse}"
				outputdir="${mxunit.tests.results.dir}" failonerror="${mxunit.failonerror}" 
				defaultrunner="/railo-tests/HttpAntRunner.cfc" inspect="true"
			/>
		</server-run>
	</target>
	
	<target name="build.and.loadtest" depends="build,loadtest">
	</target>

	<target name="loadtest">
		<antcontrib:runtarget target="server.start"/>
		<antcontrib:trycatch reference="bar">
		<try>
			<antcontrib:runtarget target="jmeter.run.and.report"/>
			<sleep seconds="3"/>
		</try>
		<catch>
			<antcontrib:runtarget target="server.stop"/>
			<property name="baz" refid="bar" />
			<echo>From reference: ${baz}</echo>
			<fail message="Something failed"/>
		</catch>
		</antcontrib:trycatch>
		<antcontrib:runtarget target="server.stop"/>
	</target>
	
	<target name="loadtest.running">
		<antcontrib:runtarget target="jmeter.runtests"/>
	</target>

	<target name="build">
		<antcontrib:runtarget target="railobuild.build"/>
	</target>

</project>
