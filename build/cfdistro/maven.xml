<project name="maven" default="nexus.install" xmlns:aether="antlib:org.sonatype.aether.ant" xmlns:antcontrib="antlib:net.sf.antcontrib" xmlns:artifact="antlib:org.apache.maven.artifact.ant" basedir=".">

   	<!-- 
   	<property name="mvn.type" value="snapshot" />
   	<property name="mvn.type" value="release" />
    <property name="mvn.repo.dest" value="remote" />
    <property name="mvn.repo.dest" value="local" />
    <property name="mvn.repo.id" value="mvn.repo.${mvn.repo.dest}" />
    <property name="maven.repo.local" location="${pub.dir}/maven2" />
   	-->
    <property name="maven.ant.tasks.jar" value="${cfdistro.basedir}/lib/maven-ant-tasks-2.1.4-SNAPSHOT.jar" />
	<path id="maven.ant.tasks.classpath" path="${maven.ant.tasks.jar}" />
    <available property="maven.ant.tasks.jar.exists" file="${maven.ant.tasks.jar}" />

	<property name="nexus.version" value="2.0.6" />
	<property name="ext.nexus.dir" location="${ext.dir}/nexus/${nexus.version}" />
	<property name="nexus.dir" location="${user.home}/nexus" />
	<property name="nexus.repo.dir" location="${user.home}/nexus/repo" />
	<property name="ext.nexus.war.uri" value="http://www.sonatype.org/downloads/nexus-${nexus.version}.war" />
	<property name="ext.nexus.war" location="${ext.nexus.dir}/nexus-${nexus.version}.war" />
	<property name="nexus.war" location="${nexus.dir}/nexus-${nexus.version}.war" />
	<property name="nexus.context" value="/nexus" />
	<available file="${nexus.war}" property="nexus.isconfigured" />
	
    <!-- This will download the "latest version" of the maven-ant-tasks if needed
    <target name="bootstrap_maven" unless="maven.ant.tasks.jar.exists">
	    <property name="maven.ant.tasks.bootstrap.location" value="https://builds.apache.org/job/maven-ant-tasks/org.apache.maven$maven-ant-tasks/lastSuccessfulBuild/artifact/org.apache.maven/maven-ant-tasks/2.1.4-SNAPSHOT/maven-ant-tasks-2.1.4-SNAPSHOT.jar" />
        <get src="${maven.ant.tasks.bootstrap.location}" dest="${maven.ant.tasks.jar}" />
    </target>
     -->
	<property name="nexus.admin.user" value="${ci.admin.user}" />
	<property name="nexus.admin.password" value="${ci.admin.password}" />
   	<property name="nexus.port" value="8081" />
   	<property name="nexus.host" value="127.0.0.1" />
   	<property name="nexus.baseurl" value="http://${nexus.host}:${nexus.port}/nexus" />
	
	<property name="nexus.background" value="true" />

	<target name="nexus.install">
		<mkdir dir="${ext.nexus.dir}"/>
		<mkdir dir="${nexus.dir}"/>
		<sequential>
			<required-resource
				src="${ext.nexus.war.uri}"
				dest="${ext.nexus.war}"/>
			<unzip src="${ext.nexus.war}" dest="${nexus.war}" />
		</sequential>
	</target>

	<target name="nexus.configure" unless="nexus.isconfigured">
		<mkdir dir="${nexus.dir}"/>
		<sequential>
			<!-- <cfdistro target="cfdistro.dist" properties="dist.dir=${nexus.dir}/workspace/cfdistrojob/" /> -->
			<required-resource
				src="${ext.nexus.war.uri}"
				dest="${ext.nexus.war}"
			/>
			<antcontrib:runtarget target="nexus.install" />
			<sha plaintext="${nexus.admin.password}" property="nexus.admin.password.hash" />
			<echo message="Admin: ${nexus.admin.user} ${nexus.admin.password} (${nexus.admin.password.hash})" />
			<property name="nexus.nonpub.password" value="nonpubpass" />
			<sha plaintext="${nexus.nonpub.password}" property="nexus.nonpub.password.hash" />
			<propertyfile file="${nexus.war}/WEB-INF/plexus.properties">
				<entry  key="nexus-work" value="${nexus.dir}/sonatype-work"/>
				<entry  key="security-xml-file" value="${nexus.dir}/security.xml"/>
			</propertyfile>
			<echo file="${nexus.dir}/security.xml"><![CDATA[<?xml version="1.0" encoding="UTF-8"?><security><version>2.0.5</version>
				  <users>
				    <user>
				      <id>${nexus.admin.user}</id>
				      <firstName>Administrator</firstName>
				      <password>${nexus.admin.password.hash}</password>
				      <status>active</status>
				      <email>changeme@yourcompany.com</email>
				    </user>
				    <user>
				      <id>nonpub</id>
				      <firstName>nonpub</firstName>
				      <password>${nexus.nonpub.password.hash}</password>
				      <status>active</status>
				      <email>noreply@nowhere.com</email>
				    </user>
				    <user>
				      <id>anonymous</id>
				      <firstName>Nexus</firstName>
				      <lastName>Anonymous User</lastName>
				      <password>0a92fab3230134cca6eadd9898325b9b2ae67998</password>
				      <status>active</status>
				      <email>changeme2@yourcompany.com</email>
				    </user>
				  </users>
				  <userRoleMappings>
				    <userRoleMapping>
				      <userId>ci</userId>
				      <source>default</source>
				      <roles>
				        <role>nx-admin</role>
				      </roles>
				    </userRoleMapping>
				    <userRoleMapping>
				      <userId>anonymous</userId>
				      <source>default</source>
				      <roles>
				        <role>anonymous</role>
				      </roles>
				    </userRoleMapping>
				  </userRoleMappings>
				</security>
				]]></echo>

			<unzip src="${nexus.war}/WEB-INF/lib/nexus-oss-edition-2.0.6.jar" dest="${nexus.dir}/sonatype-work/conf/">
			    <patternset>
			        <include name="META-INF/nexus/nexus.xml"/>
			    </patternset>
			    <mapper type="flatten"/>
			</unzip>
			<xmltask source="${nexus.dir}/sonatype-work/conf/nexus.xml" dest="${nexus.dir}/sonatype-work/conf/nexus.xml">
				<cut path="nexusConfiguration/repositories/repository[id[text()='releases']]" buffer="releaseReop" />
				<cut path="nexusConfiguration/repositories/repository[id[text()='snapshots']]" buffer="snapshotReop"/>
				<remove path="nexusConfiguration/repositories/*"/>
				<paste path="nexusConfiguration/repositories" buffer="releaseReop"/>
				<paste path="nexusConfiguration/repositories" buffer="snapshotReop"/>
				<remove path="nexusConfiguration/repositories/repository[id[text()='releases']]/localStorage/*"/>
				<insert path="nexusConfiguration/repositories/repository[id[text()='releases']]" 
					xml="&lt;localStorage&gt;&lt;provider&gt;file&lt;/provider&gt;&lt;url&gt;${nexus.repo.dir}&lt;/url&gt;&lt;/localStorage&gt;" />
				<insert path="nexusConfiguration/restApi"><![CDATA[<baseUrl>${nexus.baseurl}</baseUrl>
				    <forceBaseUrl>true</forceBaseUrl>]]>
				</insert>
			</xmltask>

		</sequential>

	</target>

	<target name="nexus.start" depends="nexus.configure">
		<java jar="${cfdistro.basedir}/lib/runwar.jar" fork="true" spawn="false" maxmemory="${runwar.maxmemory}" failonerror="true">
			<jvmarg line="${server.jvm.args}"/>
			<arg value="-war" /><arg value="${nexus.war}/" />
			<arg value="-context" /><arg value="${nexus.context}" />
			<arg value="-host" /><arg value="${nexus.host}" />
			<arg value="-port" /><arg value="${nexus.port}" />
			<arg value="-stop-port" /><arg value="8992" />
			<arg value="-enable-ajp" /><arg value="false" />
			<arg value="-ajp-port" /><arg value="${server.port.ajp}" />
			<arg value="-log-dir" /><arg value="${nexus.dir}" />
			<arg value="-loglevel" /><arg value="INFO" />
			<arg value="-dirs" /><arg value="${nexus.dir}" />
			<arg value="-background" /><arg value="${nexus.background}" />
			<arg value="-requestlog" /><arg value="false" />
			<arg value="-open-browser" /><arg value="false" />
			<arg value="-open-url" /><arg value="none" />
			<arg value="-osxprocessname" /><arg value="nexus" />
		</java>
	</target>

	<target name="nexus.stop" depends="nexus.configure">
		<java jar="${cfdistro.basedir}/lib/runwar.jar" fork="true" spawn="false" maxmemory="${runwar.maxmemory}" failonerror="true">
			<jvmarg line="${server.jvm.args}"/>
			<arg value="-stop" /><arg value="8992" />
		</java>
	</target>
	
    <!-- This will initialize all the maven ant tasks and download the requested artifact and its dependencies -->
    <target name="get" xmlns:artifact="antlib:org.apache.maven.artifact.ant">
        <path id="maven.ant.tasks.classpath" path="${maven.ant.tasks.jar}" />
        <typedef resource="org/apache/maven/artifact/ant/antlib.xml" uri="urn:maven-artifact-ant" classpathref="maven.ant.tasks.classpath" />
        <condition property="maven.repo.local" value="${maven.repo.local}" else="${user.home}/.m2/repository">
            <isset property="maven.repo.local" />
        </condition>
        <echo>maven.repo.local=${maven.repo.local}</echo>
        <artifact:localRepository id="local.repository" path="${maven.repo.local}" />
        <artifact:dependencies pathId="build.classpath" sourcesFilesetId="sources.id">
            <dependency groupId="${mvn.get.groupId}" artifactId="${mvn.get.artifactId}" version="${mvn.get.version}"/>
            <localRepository refid="local.repository" />
        </artifact:dependencies>
    </target>

	<macrodef name="mvn-repo">
		<attribute name="id" />
		<attribute name="url"/>
		<element name="authentication" optional="true" />
		<element name="enablement" optional="true" />
		<sequential>
			<typedef resource="org/apache/maven/artifact/ant/antlib.xml"
				uri="antlib:org.apache.maven.artifact.ant" classpathref="maven.ant.tasks.classpath" />
		    <artifact:remoteRepository id="@{id}" url="@{url}">
		      	<authentication />
		      	<enablement />
		    </artifact:remoteRepository>
		</sequential>
	</macrodef>


	<macrodef name="mvn-get" xmlns:artifact="antlib:org.apache.maven.artifact.ant">
		<attribute name="groupId" />
		<attribute name="artifactId"/>
		<attribute name="version"/>
		<attribute name="type" default="zip"/>
		<attribute name="toFile" default=""/>
		<sequential>
	        <path id="maven.ant.tasks.classpath" path="${maven.ant.tasks.jar}" />
	        <typedef resource="org/apache/maven/artifact/ant/antlib.xml" uri="urn:maven-artifact-ant" classpathref="maven.ant.tasks.classpath" />
	        <artifact:dependencies>
	            <dependency groupId="@{groupId}" artifactId="@{artifactId}" version="@{version}" type="@{type}"/>
	            <localRepository path="${cfdistro.repo.local.path}" />
	            <remoteRepository refid="cfdistro.repo.local" />
	            <remoteRepository refid="cfdistro.repo.remote" />
	        </artifact:dependencies>
	        <antcontrib:if>
	        	<equals arg1="@{toFile}" arg2="" />
	        	<then/><else>
					<antcontrib:propertyregex 
					property="dependency.location" 
					input="@{groupId}/@{artifactId}" 
					global="true" override="yes" 
					regexp="\." 
					replace="/" />
					<copy tofile="@{toFile}" file="${cfdistro.repo.local.path}/${dependency.location}/@{version}/@{artifactId}-@{version}.@{type}" />
	        	</else>
	        </antcontrib:if>
		</sequential>
	</macrodef>
	
	<macrodef name="dependency">
		<attribute name="groupId" />
		<attribute name="artifactId"/>
		<attribute name="version"/>
		<attribute name="type" default="zip"/>
		<attribute name="mapping" default=""/>
		<attribute name="dest" default=""/>
		<sequential>
			<antcontrib:propertyregex 
			property="dependency.location" 
			input="@{groupId}/@{artifactId}" 
			global="true" override="yes" 
			regexp="\." 
			replace="/" />
			<antcontrib:var name="_dep.loc" value="${cfdistro.repo.local.path}/${dependency.location}/@{version}/"/>
			<antcontrib:var name="_dep.file" value="${cfdistro.repo.local.path}/${dependency.location}/@{version}/@{artifactId}-@{version}.@{type}"/>
			<mvn-get groupId="@{groupId}" artifactId="@{artifactId}" version="@{version}" type="@{type}" />
			<antcontrib:if>
				<equals arg1="${mapping}" arg2="" />
				<then/>
				<else>
					<antcontrib:var name="ext.mapping.dir" value="${ext.dir}/mappings/@{groupId}/@{artifactId}/@{version}" />
					<antcontrib:if>
						<available file="${ext.mapping.dir}"/><then/>
						<else>
							<unzip src="${_dep.file}" dest="${ext.mapping.dir}"/>
						</else>
					</antcontrib:if>
					<mapping physical="${ext.mapping.dir}/@{mapping}" virtual="@{mapping}"/>
				</else>
			</antcontrib:if>
			<antcontrib:if>
				<equals arg1="${dest}" arg2="" /><then/>
				<else>
					<antcontrib:if>
						<available file="@{dest}"/><then/>
						<else>
							<unzip src="${_dep.file}" dest="@{dest}"/>
						</else>
					</antcontrib:if>
				</else>
			</antcontrib:if>
		</sequential>
	</macrodef>

	<macrodef name="mvn-put" xmlns:artifact="antlib:org.apache.maven.artifact.ant">
		<attribute name="artifact"/>
		<attribute name="groupId" />
		<attribute name="artifactId"/>
		<attribute name="version"/>
		<attribute name="packaging" default="jar" />
		<attribute name="repoId" default="${mvn.repo.id}" />
		<sequential>
		<artifact:install-provider artifactId="wagon-ssh" version="1.0-beta-2"/>
		<pom-and-deploy pomid="cfdistro.put.pom" artifact="@{artifact}" packaging="@{packaging}" buildtype="release"
		 groupId="@{groupId}" artifactId="@{artifactId}" version="@{version}" repoId="@{repoId}"/>
		</sequential>
	</macrodef>	
	
	<macrodef name="pom-and-deploy">
		<attribute name="pomid" />
		<attribute name="buildtype" default="release" />
		<attribute name="artifact" default="" />
		<attribute name="file" default="" />
		<attribute name="groupId" default="" />
		<attribute name="artifactId" default="" />
		<attribute name="version" default="" />
		<attribute name="name" default="" />
		<attribute name="packaging" default="jar" />
		<attribute name="repoId" default="${mvn.repo.id}" />
		<element name="dependencies" optional="true" />
		<element name="attachments" optional="true" />
		 <!-- <attach file="${basedir}/target/my-project-1.0-sources.jar" type="jar" classifier="sources"/> -->
		<sequential>
			<typedef resource="org/apache/maven/artifact/ant/antlib.xml"
				uri="antlib:org.apache.maven.artifact.ant" classpathref="maven.ant.tasks.classpath" />
			<!-- <artifact:install-provider artifactId="wagon-ssh" version="1.0-beta-2"/> -->
    		<echoproperties prefix="repository." />
			<antcontrib:if>
				<equals arg1="@{buildtype}" arg2="snapshot" />
				<then>
    				<property name="__buildtype.suffix" value="-SNAPSHOT" /> 
				</then>
			</antcontrib:if>
    		<property name="__buildtype.suffix" value="" /> 
			<antcontrib:if>
				<equals arg1="@{file}" arg2="" />
				<then>
					<artifact:pom id="@{pomid}_tmp" groupId="@{groupId}" artifactId="@{artifactId}" version="@{version}${__buildtype.suffix}" name="@{name}" packaging="@{packaging}">
			        	<dependencies />
					</artifact:pom>
					<bug170workaround pomid="@{pomid}" />
				</then>
				<else>
					<artifact:pom id="@{pomid}" file="@{file}">
			        	<dependencies />
					</artifact:pom>
				</else>
			</antcontrib:if>

			<antcontrib:if>
				<equals arg1="@{artifact}" arg2="" />
				<then>
					<artifact:deploy>
					  <remoteRepository refid="${mvn.repo.id}" />
			          <attachments />
					  <pom refid="@{pomid}"/>
					</artifact:deploy>
				</then>
				<else>
				<!-- 
					<artifact:mvn>
						<localRepository path="/tmp/farter" />
						<arg value="org.apache.maven.plugins:maven-deploy-plugin:2.6:deploy-file" />
						<arg value="-Durl=${maven-snapshots-repository-url}" />
						<arg value="-DrepositoryId=${mvn.repo.id}" />
						<arg value="-DpomFile=@{pomid}" />
						<arg value="-Dfile=@{artifact}" />
					</artifact:mvn>
				 -->
					<artifact:deploy file="@{artifact}">
					  <remoteRepository refid="@{repoId}" />
			          <attachments />
					  <pom refid="@{pomid}"/>
					</artifact:deploy>
				</else>
			</antcontrib:if>
		</sequential>
	</macrodef>
		
	<macrodef name="bug170workaround">
		<attribute name="pomid" />
		<attribute name="dir" default="/tmp" />
		<sequential>
			<artifact:writepom pomrefid="@{pomid}_tmp" file="@{dir}/tmppom.xml" trim="true"/>
			<artifact:pom id="@{pomid}" file="@{dir}/tmppom.xml" />
		</sequential>
	</macrodef>

	<property name="loganberry.repo.user" value="admin" />
   	<property name="loganberry.repo.password" value="admin123" />
    <mvn-repo id="loganberry.repo" url="http://loganberry.viviotech.net/nexus/content/repositories/releases">
    	<authentication>
    		<authentication username="${loganberry.repo.user}" password="${loganberry.repo.password}"/>
		</authentication>
    </mvn-repo>
	
</project>
