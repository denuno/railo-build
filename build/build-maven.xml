<project name="build-maven" default="build.mvn" xmlns:antcontrib="antlib:net.sf.antcontrib" xmlns:artifact="antlib:org.apache.maven.artifact.ant" basedir=".">

   	<!-- 
   	<property name="mvn.type" value="snapshot" />
   	-->
   	<property name="mvn.type" value="release" />
    <property name="mvn.repo.dest" value="local" />
    <property name="mvn.repo.dest" value="remote" />
    <property name="mvn.repo.id" value="mvn.repo.${mvn.repo.dest}" />
    <property name="maven.repo.local" location="${pub.dir}/mvnrepo" />
	<import file="${cfdistro.basedir}/maven.xml" />

	<mvn-repo id="mvn.repo.local" url="file://${maven.repo.local}" />

    <property name="repository.username" value="cfml" />
    <property name="repository.privatekey" value="${basedir}/mvnkey.key" />
    <mvn-repo id="mvn.repo.remote" url="scp://loganberry.viviotech.net:10022/home/cfml/railo-build/pub/maven2">
      	<authentication username="${repository.username}" privateKey="${repository.privatekey}"/>
    </mvn-repo>
	<!-- default jre to use for building jre bundles -->
	<property name="mvn.jre.version" value="1.7.0_04" />
       	
  	<property name="mvn.remote.repo" 
   		value="http://127.0.0.1:8081/nexus/content/repositories/railo-${mvn.type}s/" />

    <target name="mvn.deploy.jre" depends="bootstrap_maven,set.build.info" xmlns:artifact="antlib:org.apache.maven.artifact.ant">
		<!-- only used to fill repo initially - put exploded JREs in arch subdirs -->
		<property name="mvn.jre.tmp" location="${temp.dir}/jre" />
		<property name="mvn.jre.version" value="1.7.0_04" />
		<property name="mvn.jre.version" value="1.6.0_32" />
		<property name="mvn.jre.dir" value="${basedir}/../jre" />
		
		<zip destfile="${mvn.jre.tmp}/jre-linux32.zip" update="false">
			<zipfileset dir="${mvn.jre.dir}/linux32/jre${mvn.jre.version}" prefix="jre/"/>
		</zip>
		<zip destfile="${mvn.jre.tmp}/jre-linux64.zip" update="false">
			<zipfileset dir="${mvn.jre.dir}/linux64/jre${mvn.jre.version}" prefix="jre/"/>
		</zip>
		<zip destfile="${mvn.jre.tmp}/jre-win32.zip" update="false">
			<zipfileset dir="${mvn.jre.dir}/win32/jre${mvn.jre.version}" prefix="jre/"/>
		</zip>
		<zip destfile="${mvn.jre.tmp}/jre-win64.zip" update="false">
			<zipfileset dir="${mvn.jre.dir}/win64/jre${mvn.jre.version}" prefix="jre/"/>
		</zip>
		<pom-and-sshit pomid="jre.pom" packaging="pom"
		 groupId="oracle" artifactId="jre" version="${mvn.jre.version}" name="oracle.jre">
			<attachments>
        		<attach file="${mvn.jre.tmp}/jre-win32.zip" type="zip" classifier="win32"/>
        		<attach file="${mvn.jre.tmp}/jre-win64.zip" type="zip" classifier="win64"/>
        		<attach file="${mvn.jre.tmp}/jre-linux32.zip" type="zip" classifier="linux32"/>
        		<attach file="${mvn.jre.tmp}/jre-linux64.zip" type="zip" classifier="linux64"/>
			</attachments>
		</pom-and-sshit>
		<delete dir="${mvn.jre.tmp}" />
	</target>

    <target name="mvn.deploy.libs" depends="bootstrap_maven,set.build.info" xmlns:artifact="antlib:org.apache.maven.artifact.ant">
		<!-- wrap all the libs up into one dependency -->
		<zip destfile="${temp.dir}/railo-libs.zip" update="true">
			<fileset dir="${src.dir}/railo-java/libs" excludes="railo-loader.jar" />
		</zip>
		<pom-and-sshit pomid="railolibs.pom" packaging="pom"
		 groupId="org.getrailo" artifactId="railo.libs" version="${railo.build.version.major}.0" name="railo.libs">
			<attachments>
        		<attach file="${temp.dir}/railo-libs.zip" type="zip"/>
			</attachments>
		</pom-and-sshit>
		<delete file="${temp.dir}/railo-libs.zip" />
	</target>

    <target name="mvn.deploy.core" depends="bootstrap_maven,set.build.info" xmlns:artifact="antlib:org.apache.maven.artifact.ant">
		<!-- deploy the railo.jar file (railo.core) -->
		<pom-and-sshit pomid="railo.core.pom" packaging="pom"
		 groupId="org.getrailo" artifactId="railo.core" version="${railo.build.version.long}" name="railo.core">
        	<dependencies>
        		<dependency groupId="org.getrailo" artifactId="railo.libs" version="${railo.build.version.major}.0" type="zip"/>
        	</dependencies>
        	<attachments>
        		<attach file="${railobuild.dist.dir}/jar/railo-${railo.build.version.long}.jar" type="jar"/>
        		<attach file="${railobuild.dist.dir}/rc/${railo.build.version.long}.rc" type="rc"/>
        	</attachments>
		</pom-and-sshit>

		<!-- deploy the railo archtype-ish projects -->
		<copy file="${basedir}/resource/maven/railo.pom" tofile="${temp.dir}/railo.pom" overwrite="true">
			<filterchain><expandproperties /></filterchain>
		</copy>
		<pom-and-sshit pomid="railopom" file="${temp.dir}/railo.pom"  packaging="pom"
			artifact="${railobuild.dist.dir}/jar/railo-${railo.build.version.long}.jar"/>

		<copy file="${basedir}/resource/maven/railo-war.pom" tofile="${temp.dir}/railo-war.pom" overwrite="true">
			<filterchain><expandproperties /></filterchain>
		</copy>
		<pom-and-sshit pomid="railo-war.pom" file="${temp.dir}/railo-war.pom"
		  artifact="${railobuild.dist.dir}/jar/railo-${railo.build.version.long}.jar" packaging="pom" />

		<copy file="${basedir}/resource/maven/railo-jetty.pom" tofile="${temp.dir}/railo-jetty.pom" overwrite="true">
			<filterchain><expandproperties /></filterchain>
		</copy>
		<pom-and-sshit pomid="railo-jetty.pom" file="${temp.dir}/railo-jetty.pom" packaging="pom"
			artifact="${rai5lobuild.dist.dir}/jar/railo-${railo.build.version.long}.jar" />
	</target>

</project>
